# 論文要約機能 仕様書

## 概要

論文PDFをGemini AIで要約し、要約ページを表紙の後ろに挿入した新しいPDFを生成する機能。生成されたPDFは自動的に「要約」本棚に追加される。

---

## 機能フロー

```
1. 論文PDFを開く
2. AI解析メニュー → 「論文を要約」選択
3. 確認ダイアログ（API使用量の警告）
4. Geminiが論文全体を解析
   - 表紙画像 → タイトル・著者抽出
   - 各ページ → 本文抽出・要約生成
5. 要約ページをPDFとして生成
6. 元PDFの表紙の後ろに挿入
7. 「論文名_要約.pdf」として保存
8. 「要約」本棚に自動追加
9. セマンティック検索インデックスに追加
```

---

## 要約ページの構成

```
┌─────────────────────────────────────┐
│           AI要約                    │
│   ─────────────────────────         │
│   論文タイトル: XXXXX               │
│   著者: XXXXX                       │
│   要約生成日: 2025/01/14            │
│                                     │
│   ■ 概要 (Abstract)                 │
│   本論文は〜について述べている...    │
│                                     │
│   ■ 主要な発見・結論                │
│   1. 〜であることが示された          │
│   2. 〜という結果が得られた          │
│   3. 〜が明らかになった              │
│                                     │
│   ■ 研究手法                        │
│   〜を用いて分析を行った...          │
│                                     │
│   ■ 図表のポイント                  │
│   - Figure 1: 〜を示している         │
│   - Table 2: 〜の比較結果            │
│                                     │
│   ■ キーワード                      │
│   機械学習, 自然言語処理, ...        │
│                                     │
│   ─────────────────────────         │
│   Generated by PDF Reader + Gemini  │
└─────────────────────────────────────┘
```

---

## Gemini プロンプト設計

### Step 1: 表紙解析
```
この論文の表紙から以下の情報を抽出してください：
- 論文タイトル
- 著者名
- 所属機関
- 発行年
- ジャーナル名（あれば）

JSON形式で出力してください。
```

### Step 2: 本文要約
```
以下は学術論文のページです。論文全体の要約を以下の形式で作成してください：

1. 概要（Abstract）: 100-150文字で論文の主旨を要約
2. 主要な発見・結論: 3-5項目の箇条書き
3. 研究手法: 50-100文字で手法を説明
4. 図表のポイント: 重要な図表とその意味を列挙
5. キーワード: 5-10個の重要な専門用語

日本語で出力してください。
```

---

## データモデル

### PaperSummary（論文要約）
```swift
struct PaperSummary: Codable, Identifiable {
    let id: UUID
    let originalBookId: UUID       // 元の論文のBook ID
    let summaryBookId: UUID        // 要約付きPDFのBook ID
    let title: String              // 論文タイトル
    let authors: [String]          // 著者
    let abstractSummary: String    // 概要
    let keyFindings: [String]      // 主要な発見
    let methodology: String        // 研究手法
    let figureNotes: [String]      // 図表メモ
    let keywords: [String]         // キーワード
    let createdAt: Date
}
```

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      ContentView                             │
│  AI解析メニュー → 「論文を要約」                             │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                 PaperSummaryService                          │
│  - Gemini呼び出し（表紙解析 + 本文要約）                      │
│  - 要約ページPDF生成                                         │
│  - PDF合成（元PDF + 要約ページ）                             │
└────────────────────────────┬────────────────────────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
┌─────────────▼───┐ ┌────────▼────────┐ ┌───▼───────────────┐
│  GeminiService  │ │ PDFGenerator    │ │ BookshelfManager  │
│  (API呼び出し)  │ │ (PDF生成・合成) │ │ (要約本棚に追加)  │
└─────────────────┘ └─────────────────┘ └───────────────────┘
```

---

## 新規ファイル

| ファイル | 役割 |
|---------|------|
| `PaperSummaryService.swift` | 論文要約のオーケストレーション |
| `PDFGenerator.swift` | 要約ページPDF生成・PDF合成 |

---

## 既存ファイル変更

| ファイル | 変更内容 |
|---------|---------|
| `GeminiService.swift` | 論文要約用のプロンプト追加 |
| `ContentView.swift` | AI解析メニューに「論文を要約」追加 |
| `LibraryManager.swift` | 要約PDF保存時の処理 |

---

## 実装フェーズ

### Phase 1: PDF生成基盤
1. `PDFGenerator`作成（テキストからPDFページ生成）
2. PDF合成機能（元PDF + 新ページ → 新PDF）

### Phase 2: Gemini連携
1. 表紙解析プロンプト実装
2. 本文要約プロンプト実装
3. `PaperSummaryService`作成

### Phase 3: UI統合
1. AI解析メニューに「論文を要約」追加
2. 進捗表示UI（ページ解析中...）
3. 完了通知・要約本棚への誘導

### Phase 4: 検索連携
1. 要約テキストをセマンティック検索インデックスに追加
2. 要約PDFの検索結果に「要約」バッジ表示

---

## API使用量の考慮

### 制限事項
- 1論文あたり最大20ページまで解析（超過時は警告）
- 1日あたりの要約生成数を設定で制限可能

### 確認ダイアログ
```
「論文を要約」

この論文は全15ページです。
要約生成にはGemini APIを使用します。

[キャンセル]  [要約を生成]
```

---

## PDF生成の技術詳細

### UIKit/PDFKit を使用
```swift
func generateSummaryPage(summary: PaperSummary) -> PDFPage {
    let pageRect = CGRect(x: 0, y: 0, width: 595, height: 842)  // A4
    let renderer = UIGraphicsPDFRenderer(bounds: pageRect)

    let data = renderer.pdfData { context in
        context.beginPage()
        // タイトル描画
        // 各セクション描画
        // フッター描画
    }

    let pdfDocument = PDFDocument(data: data)!
    return pdfDocument.page(at: 0)!
}
```

### PDF合成
```swift
func insertSummaryPage(into original: PDFDocument, summaryPage: PDFPage) -> PDFDocument {
    let newDocument = PDFDocument()

    // 1ページ目（表紙）をコピー
    if let coverPage = original.page(at: 0) {
        newDocument.insert(coverPage, at: 0)
    }

    // 要約ページを挿入
    newDocument.insert(summaryPage, at: 1)

    // 残りのページをコピー
    for i in 1..<original.pageCount {
        if let page = original.page(at: i) {
            newDocument.insert(page, at: newDocument.pageCount)
        }
    }

    return newDocument
}
```

---

## 検証方法

1. **要約生成**: 論文PDFを開いて「論文を要約」を実行、要約が生成されることを確認
2. **PDF挿入**: 新PDFで2ページ目に要約ページが挿入されていることを確認
3. **本棚連携**: 要約PDFが「要約」本棚に自動追加されることを確認
4. **検索連携**: 要約内容で検索して該当論文がヒットすることを確認
5. **ページ制限**: 20ページ超の論文で警告が表示されることを確認
