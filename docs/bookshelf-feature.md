# 本棚機能 仕様書

## 概要

PDFを本棚（カテゴリ）ごとに整理し、本棚単位で表示・検索できる機能。

---

## 機能一覧

### 1. 本棚管理

#### 1.1 本棚の種類
| 種類 | 説明 | 削除可否 |
|------|------|----------|
| すべて | 全書籍を表示（仮想本棚） | 不可 |
| 要約 | 論文要約PDFが自動で入る | 不可 |
| ユーザー作成 | 自由に作成・編集可能 | 可 |

#### 1.2 本棚の操作
- **作成**: 本棚名を入力して新規作成
- **編集**: 本棚名の変更、アイコン選択
- **削除**: ユーザー作成の本棚のみ削除可能（中の本は「すべて」に残る）
- **並べ替え**: ドラッグ&ドロップで順序変更

#### 1.3 本の整理
- 本を開いた状態または本棚画面から本棚を変更
- 1冊の本は1つの本棚にのみ所属
- 本棚未設定の本は「すべて」でのみ表示

---

### 2. 本棚単位の検索

#### 2.1 検索スコープ
- **すべて**: 全ライブラリ横断検索（現行動作）
- **選択中の本棚**: 現在表示中の本棚内のみ検索

#### 2.2 VecturaKit DB構成
- 本棚ごとに個別のDBを持つのではなく、チャンクに`bookshelfId`を付与
- 検索時にフィルタリングで本棚を絞り込む

---

### 3. UI/UX

#### 3.1 本棚一覧（サイドバー or タブ）
```
┌─────────────────────────────────────┐
│  [すべて]  [要約]  [論文]  [+]      │  ← 横スクロールタブ
├─────────────────────────────────────┤
│                                     │
│   📕  📗  📘  📙  📕  📗            │  ← 選択中の本棚の本
│                                     │
└─────────────────────────────────────┘
```

#### 3.2 本棚の選択
- 画面上部にタブ形式で本棚を表示
- タップで本棚切り替え
- 「+」ボタンで新規本棚作成

#### 3.3 本の移動
- 本を長押し → コンテキストメニュー → 「本棚を変更」
- 本棚選択ピッカーが表示される

---

## データモデル

### Bookshelf（本棚）
```swift
struct Bookshelf: Identifiable, Codable {
    let id: UUID
    var name: String
    var icon: String           // SF Symbolsアイコン名
    var color: String          // カラーコード
    let isSystemShelf: Bool    // システム本棚（削除不可）
    var sortOrder: Int         // 表示順序
    let createdAt: Date
}
```

### Book（変更）
```swift
struct Book: Identifiable, Codable {
    var id = UUID()
    let fileName: String
    let importDate: Date
    var isRightToLeft: Bool?
    var isIndexed: Bool = false
    var bookshelfId: UUID?     // NEW: 所属本棚（nilなら未分類）
}
```

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                      ContentView                             │
│  (本棚タブ + 選択中の本棚の書籍グリッド)                      │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                    BookshelfManager                          │
│  - 本棚CRUD                                                  │
│  - システム本棚の初期化                                       │
│  - 本の本棚移動                                               │
└────────────────────────────┬────────────────────────────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
┌─────────────▼─────────────┐ ┌─────────────▼─────────────┐
│    LibraryManager         │ │ SemanticSearchManager     │
│    (Book管理)             │ │ (bookshelfIdフィルタ追加) │
└───────────────────────────┘ └───────────────────────────┘
```

---

## 新規ファイル

| ファイル | 役割 |
|---------|------|
| `BookshelfManager.swift` | 本棚の管理ロジック |
| `BookshelfTabView.swift` | 本棚タブUI |
| `BookshelfEditorView.swift` | 本棚作成・編集画面 |

---

## 既存ファイル変更

| ファイル | 変更内容 |
|---------|---------|
| `LibraryManager.swift` | `Book`に`bookshelfId`追加 |
| `ContentView.swift` | 本棚タブ統合、フィルタリング表示 |
| `SemanticSearchManager.swift` | 本棚フィルタ検索対応 |
| `SearchView.swift` | 検索スコープ選択UI |

---

## 実装フェーズ

### Phase 1: 本棚基盤
1. `Bookshelf`モデル作成
2. `BookshelfManager`作成
3. システム本棚（すべて、要約）の初期化
4. `Book`に`bookshelfId`追加

### Phase 2: 本棚UI
1. `BookshelfTabView`作成
2. `ContentView`に本棚タブ統合
3. 本棚でフィルタした書籍表示
4. 本棚作成・編集UI

### Phase 3: 本の整理
1. 本のコンテキストメニューに「本棚を変更」追加
2. 本棚選択ピッカー
3. 新規インポート時の本棚選択

### Phase 4: 検索連携
1. `SemanticSearchManager`に本棚フィルタ追加
2. `SearchView`に検索スコープ選択
3. 本棚単位での検索結果表示

---

## システム本棚の初期化

```swift
// アプリ初回起動時に自動作成
let systemShelves = [
    Bookshelf(
        id: UUID(),  // 固定UUIDを使用
        name: "すべて",
        icon: "books.vertical",
        color: "#007AFF",
        isSystemShelf: true,
        sortOrder: 0,
        createdAt: Date()
    ),
    Bookshelf(
        id: UUID(),  // 固定UUIDを使用
        name: "要約",
        icon: "doc.text.magnifyingglass",
        color: "#34C759",
        isSystemShelf: true,
        sortOrder: 1,
        createdAt: Date()
    )
]
```

---

## 検証方法

1. **本棚作成**: 新規本棚を作成し、一覧に表示されることを確認
2. **本の移動**: 本を別の本棚に移動し、表示が切り替わることを確認
3. **フィルタ表示**: 本棚タブを切り替えると該当する本のみ表示されることを確認
4. **本棚削除**: ユーザー本棚を削除し、中の本が残ることを確認
5. **検索スコープ**: 本棚単位で検索結果がフィルタされることを確認
